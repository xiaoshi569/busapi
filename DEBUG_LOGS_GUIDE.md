# 注册流程调试日志说明

本文档说明了为 business2api 项目注册流程添加的详细调试日志功能。

## 📋 概述

为了方便调试和跟踪注册过程，我们在以下关键模块添加了详细的调试日志：

1. **注册流程控制** (register.go)
2. **浏览器自动化注册** (browser.go)
3. **邮箱获取与验证码提取**
4. **账号保存**

## 🎯 主要改进

### 1. 注册流程启动 (register.go)

#### `startRegister()` 函数
添加了以下日志点：
- 🚀 注册流程启动信息
- 📁 数据目录路径
- 🧵 线程数量和启动状态
- 👀 进度监控器启动
- 📊 定期进度报告（每10秒）
  - 当前账号数/目标数
  - 完成百分比
  - 就绪/待刷新账号统计

示例输出：
```
🚀 [注册流程] 开始启动注册流程，目标注册数量: 50
📁 [注册流程] 数据目录: /app/data
🧵 [注册流程] 启动 3 个注册线程
   ➜ 启动线程 1
   ➜ 启动线程 2
   ➜ 启动线程 3
👀 [注册流程] 启动进度监控器（每10秒检查一次）
✅ [注册流程] 注册流程启动成功
```

#### `checkAndMaintainPool()` 函数
添加了详细的号池维护日志：
- 🔍 定期检查开始/结束标记
- 📂 数据重载信息
- 📊 账号池详细状态
  - 就绪账号数
  - 待刷新账号数
  - 总账号数
  - 目标完成百分比
  - 最小账号数阈值
- ⚠️ 账号缺口警告
- 🚨 低于最小值紧急提示

### 2. 浏览器注册流程 (browser.go)

#### `RunBrowserRegister()` 函数
完整的8步注册流程，每步都有详细日志：

**步骤 1/8: 获取临时邮箱**
```
📧 [注册 1] 步骤 1/8: 获取临时邮箱...
✅ [注册 1] 获取到邮箱: user123@example.com
```

**步骤 2/8: 启动浏览器**
```
🌐 [注册 1] 步骤 2/8: 启动浏览器...
🔍 [注册 1] 检测系统浏览器...
✅ [注册 1] 使用浏览器: /usr/bin/google-chrome
⚙️ [注册 1] 配置浏览器启动参数 (headless=true)...
🔀 [注册 1] 使用代理: socks5://proxy:1080
🚀 [注册 1] 启动浏览器实例...
✅ [注册 1] 浏览器启动成功: ws://127.0.0.1:xxxxx
✅ [注册 1] 浏览器连接成功
```

**步骤 3/8: 打开注册页面**
```
🌍 [注册 1] 步骤 3/8: 打开注册页面...
✅ [注册 1] 页面加载完成
⏳ [注册 1] 等待输入框出现（最多20秒）...
✅ [注册 1] 输入框已出现
```

**步骤 4/8: 输入邮箱地址**
```
✍️ [注册 1] 步骤 4/8: 输入邮箱地址...
📝 [注册 1] 邮箱: user123@example.com
⌨️ [注册 1] 开始输入邮箱（每个字符延迟15ms）...
✅ [注册 1] 邮箱输入完成
```

**步骤 5/8: 获取验证码**
```
🔐 [注册 1] 步骤 5/8: 获取验证码...
📬 [注册 1] 使用IMAP邮箱获取验证码 (IMAP邮箱: xxx@qq.com, 目标邮箱: user123@example.com)...
✅ [注册 1] 获取到验证码: ABC123
```

**步骤 6/8: 输入验证码**
```
✍️ [注册 1] 步骤 6/8: 输入验证码...
⌨️ [注册 1] 开始输入验证码: ABC123
✅ [注册 1] 验证码输入完成
```

**步骤 7/8: 填写姓名**
```
👤 [注册 1] 步骤 7/8: 填写姓名...
📝 [注册 1] 生成随机姓名: John Smith
⌨️ [注册 1] 开始输入姓名: John Smith
✅ [注册 1] 姓名输入完成
```

**步骤 8/8: 获取 Authorization**
```
🔑 [注册 1] 步骤 8/8: 等待获取 Authorization...
⏳ [注册 1] 最多尝试 25 次，每次间隔 3 秒...
✅ [注册 1] Authorization 获取成功
🍪 [注册 1] 收集 Cookies...
```

**注册成功总结**
```
🎉 [注册 1] ========== 注册成功 ==========
📋 [注册 1] 账号信息:
   • 邮箱: user123@example.com
   • 姓名: John Smith
   • ConfigID: abc-123-def
   • CSESIDX: 456789
   • Cookies数量: 15
   • Authorization: Bearer eyJ...
```

### 3. 临时邮箱获取 (browser.go)

#### `getTemporaryEmail()` 函数
```
📧 [临时邮箱] 开始获取临时邮箱...
✅ [临时邮箱] 检测到IMAP邮箱配置，使用自定义域名
✅ [临时邮箱] 生成自定义域名邮箱: abc123@domain.com (转发到 xxx@qq.com)
```

或使用临时邮箱服务：
```
🔄 [临时邮箱] 使用临时邮箱服务，共 1 个提供商
🔍 [临时邮箱] 尝试提供商 1/1: chatgpt.org.uk
   🌐 请求 chatgpt.org.uk API: https://...
   📥 响应大小: 256 字节
   ✅ 解析到邮箱: test@chatgpt.org.uk
✅ [临时邮箱] 从 chatgpt.org.uk 获取到邮箱: test@chatgpt.org.uk
```

### 4. 验证码提取 (browser.go)

#### `extractVerificationCode()` 函数
多策略验证码提取，每个策略都有日志：

```
🔍 [验证码提取] 开始提取验证码，内容长度: 12345 字节
   📝 MIME解码后长度: 8901 字节
   🔍 策略1: 关键词附近提取...
   ✅ 通过关键词匹配找到验证码: ABC123
```

或尝试多个策略：
```
   🔍 策略1: 关键词附近提取...
   🔍 策略2: Google格式 (G-XXXXXX)...
   ✅ 通过Google格式找到验证码: DEF456
```

或通用匹配：
```
   🔍 策略3: 通用6位字符匹配...
   📊 找到 5 个6位字符候选
   🔎 候选 1: REJECT
      ⏭️ 跳过常见词: REJECT
   🔎 候选 2: ABC123
   ✅ 找到字母数字混合验证码: ABC123
```

### 5. 注册线程 (browser.go)

#### `NativeRegisterWorker()` 函数
```
🏁 [注册线程 1] 线程启动，延迟 3 秒后开始工作
🔨 [注册线程 1] 开始第 1 次注册任务 (当前进度: 10/50)
💾 [注册线程 1] 保存注册结果到文件...
✅ [注册线程 1] 保存成功 (耗时 2m15s)，重新加载账号池
📊 [注册线程 1] 当前账号池: 总数=11, 就绪=8, 待刷新=3
```

失败时：
```
❌ [注册线程 1] 注册失败 (耗时 45s): 获取验证码超时
⏳ [注册线程 1] 检测到限流/超时错误，等待 12 秒后重试...
```

线程停止：
```
🛑 [注册线程 1] 线程停止 (共完成 15 次注册任务)
```

### 6. 账号保存 (browser.go)

#### `SaveBrowserRegisterResult()` 函数
```
💾 [保存账号] 开始保存注册结果...
📧 [保存账号] 邮箱: user123@example.com
📋 [保存账号] 账号数据:
   • Email: user123@example.com
   • FullName: John Smith
   • ConfigID: abc-123-def
   • CSESIDX: 456789
   • Cookies数量: 15
   • Timestamp: 2025-12-09T10:30:45Z
🔄 [保存账号] 序列化为JSON...
✅ [保存账号] JSON大小: 2048 字节
💾 [保存账号] 写入文件: /app/data/user123@example.com.json
✅ [保存账号] 账号保存成功: /app/data/user123@example.com.json
```

## 🔍 日志标记说明

| 图标 | 含义 |
|-----|------|
| 🚀 | 启动/开始 |
| ✅ | 成功 |
| ❌ | 失败/错误 |
| ⚠️ | 警告 |
| 🚨 | 紧急/严重 |
| 📧 | 邮箱相关 |
| 🔐 | 验证码相关 |
| 🌐 | 浏览器/网络 |
| 💾 | 保存/存储 |
| 📊 | 统计/状态 |
| 🔍 | 检查/搜索 |
| ⏳ | 等待/延迟 |
| 🔨 | 任务执行 |
| 🧵 | 线程相关 |
| 👀 | 监控 |
| 🎉 | 完成 |

## 📖 使用建议

### 1. 实时监控
```bash
# 实时查看所有日志
./business2api 2>&1 | tee -a business2api.log

# 只看注册相关日志
./business2api 2>&1 | grep "\[注册"

# 只看特定线程的日志
./business2api 2>&1 | grep "\[注册线程 1\]"
```

### 2. 调试特定步骤
```bash
# 查看邮箱获取
./business2api 2>&1 | grep "\[临时邮箱\]"

# 查看验证码提取
./business2api 2>&1 | grep "\[验证码提取\]"

# 查看账号保存
./business2api 2>&1 | grep "\[保存账号\]"
```

### 3. 监控进度
```bash
# 查看注册进度
./business2api 2>&1 | grep "\[注册进度监控\]"

# 查看号池维护
./business2api 2>&1 | grep "\[号池维护\]"
```

### 4. 错误排查
```bash
# 查看所有错误
./business2api 2>&1 | grep "❌"

# 查看失败的注册任务
./business2api 2>&1 | grep "注册失败"
```

## 🛠️ 开发建议

1. **保持一致性**：新增功能时，请保持日志格式的一致性
2. **适度详细**：日志要详细但不冗余，关键步骤必须记录
3. **使用标记**：使用表情符号标记可以快速识别日志类型
4. **结构化**：使用 `[模块] [子模块]` 的格式便于过滤
5. **包含上下文**：日志中包含必要的上下文信息（线程ID、邮箱等）

## 📝 示例：完整的注册流程日志

```
🚀 [注册流程] 开始启动注册流程，目标注册数量: 50
📁 [注册流程] 数据目录: /app/data
🧵 [注册流程] 启动 1 个注册线程
   ➜ 启动线程 1
👀 [注册流程] 启动进度监控器（每10秒检查一次）
✅ [注册流程] 注册流程启动成功

🏁 [注册线程 1] 线程启动，延迟 3 秒后开始工作
🔨 [注册线程 1] 开始第 1 次注册任务 (当前进度: 0/50)

🎬 [注册 1] ========== 开始注册流程 ==========
📋 [注册 1] 配置: headless=true, proxy=

📧 [注册 1] 步骤 1/8: 获取临时邮箱...
📧 [临时邮箱] 开始获取临时邮箱...
✅ [临时邮箱] 检测到IMAP邮箱配置，使用自定义域名
✅ [临时邮箱] 生成自定义域名邮箱: abc123@domain.com (转发到 xxx@qq.com)
✅ [注册 1] 获取到邮箱: abc123@domain.com

🌐 [注册 1] 步骤 2/8: 启动浏览器...
🔍 [注册 1] 检测系统浏览器...
✅ [注册 1] 使用浏览器: /usr/bin/google-chrome
⚙️ [注册 1] 配置浏览器启动参数 (headless=true)...
🚀 [注册 1] 启动浏览器实例...
✅ [注册 1] 浏览器启动成功: ws://127.0.0.1:xxxxx
✅ [注册 1] 浏览器连接成功

🌍 [注册 1] 步骤 3/8: 打开注册页面...
✅ [注册 1] 页面加载完成
⏳ [注册 1] 等待输入框出现（最多20秒）...
✅ [注册 1] 输入框已出现

✍️ [注册 1] 步骤 4/8: 输入邮箱地址...
📝 [注册 1] 邮箱: abc123@domain.com
⌨️ [注册 1] 开始输入邮箱（每个字符延迟15ms）...
✅ [注册 1] 邮箱输入完成

🔐 [注册 1] 步骤 5/8: 获取验证码...
📬 [注册 1] 使用IMAP邮箱获取验证码 (IMAP邮箱: xxx@qq.com, 目标邮箱: abc123@domain.com)...
✅ [注册 1] 获取到验证码: ABC123

✍️ [注册 1] 步骤 6/8: 输入验证码...
⌨️ [注册 1] 开始输入验证码: ABC123
✅ [注册 1] 验证码输入完成

👤 [注册 1] 步骤 7/8: 填写姓名...
📝 [注册 1] 生成随机姓名: John Smith
⌨️ [注册 1] 开始输入姓名: John Smith
✅ [注册 1] 姓名输入完成

🔑 [注册 1] 步骤 8/8: 等待获取 Authorization...
⏳ [注册 1] 最多尝试 25 次，每次间隔 3 秒...
✅ [注册 1] Authorization 获取成功
🍪 [注册 1] 收集 Cookies...

🎉 [注册 1] ========== 注册成功 ==========
📋 [注册 1] 账号信息:
   • 邮箱: abc123@domain.com
   • 姓名: John Smith
   • ConfigID: abc-123-def
   • CSESIDX: 456789
   • Cookies数量: 15
   • Authorization: Bearer eyJ...

💾 [注册线程 1] 保存注册结果到文件...
💾 [保存账号] 开始保存注册结果...
📧 [保存账号] 邮箱: abc123@domain.com
📋 [保存账号] 账号数据:
   • Email: abc123@domain.com
   • FullName: John Smith
   • ConfigID: abc-123-def
   • CSESIDX: 456789
   • Cookies数量: 15
   • Timestamp: 2025-12-09T10:30:45Z
🔄 [保存账号] 序列化为JSON...
✅ [保存账号] JSON大小: 2048 字节
💾 [保存账号] 写入文件: /app/data/abc123@domain.com.json
✅ [保存账号] 账号保存成功: /app/data/abc123@domain.com.json

✅ [注册线程 1] 保存成功 (耗时 2m15s)，重新加载账号池
📊 [注册线程 1] 当前账号池: 总数=1, 就绪=0, 待刷新=1

📊 [注册进度监控 #1] 当前账号数: 1 / 50 (2.0%), 就绪: 0, 待刷新: 1
```

## 🎯 总结

添加的调试日志覆盖了注册流程的所有关键环节，使得：
1. ✅ 问题定位更加快速准确
2. ✅ 流程跟踪清晰可见
3. ✅ 性能分析有据可依
4. ✅ 错误排查更加高效

所有日志都遵循统一的格式规范，便于后续维护和扩展。
